package vulnerability

import (
	"database/sql"
	"time"

	"github.com/nurdsoft/redesign-grp-trust-portal-api/internal/auth"
	"github.com/nurdsoft/redesign-grp-trust-portal-api/internal/rapid7"
	svcTransport "github.com/nurdsoft/redesign-grp-trust-portal-api/internal/transport"
	"github.com/nurdsoft/redesign-grp-trust-portal-api/internal/vulnerability/endpoints"
	"github.com/nurdsoft/redesign-grp-trust-portal-api/internal/vulnerability/service"
	"github.com/nurdsoft/redesign-grp-trust-portal-api/internal/vulnerability/transport/http"
	"github.com/nurdsoft/redesign-grp-trust-portal-api/shared/cache"
	httpTransport "github.com/nurdsoft/redesign-grp-trust-portal-api/shared/transport/http"
	"go.uber.org/fx"
)

// ModuleParams for user.
type ModuleParams struct {
	fx.In

	DB           *sql.DB
	HTTPServer   *httpTransport.Server
	APPTransport svcTransport.Client
	AuthClient   auth.Client
	Rapid7Client rapid7.Client
	CacheClient  cache.Client
}

// NewModule for redesign.
// nolint:gocritic
func NewModule(p ModuleParams) (Client, error) {
	ccache := cache.New(6*time.Hour, 7*time.Hour)
	svc := service.New(p.Rapid7Client, ccache)
	eps := endpoints.New(svc)

	client := NewClient(svc)

	http.RegisterTransport(p.HTTPServer, eps, p.AuthClient, p.APPTransport)

	return client, nil
}

var (
	// ModuleHttpAPI for uber fx.
	ModuleHttpAPI = fx.Options(fx.Provide(NewModule))
)
